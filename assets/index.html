<html>
<head>
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="http://momentjs.com/downloads/moment.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<script src="http://code.highcharts.com/modules/exporting.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/main.css">
</head>
<body>
    <script type="text/javascript">
        var sock = null;
        var wsuri = "ws://127.0.0.1:6222/ws";

		var options = {
			chart: {
				type: 'spline',
				connectNulls: true,
				events: {
					load: function () {
						var sock = new WebSocket(wsuri);
						var self = this;

						sock.onopen = function() { console.log("connected to " + wsuri); }
						sock.onclose = function(e) { console.log("connection closed (" + e.code + ")"); }
						sock.onmessage = function(e) {
							msg = JSON.parse(e.data);

							if (msg.type === 'status') {
								document.getElementById('status').innerHTML = msg.status;
								if (msg.status === "Finished") {
									document.getElementById('commit_block').style.visibility = "hidden";
								} else {
									date = moment(msg.commit.date).format('YYYY-MM-DD HH:mm:ss');
									document.getElementById('commit').innerHTML = date + ' (' + msg.commit.subject + ')' + '<br />' + 'Hash: ' + msg.commit.hash;
								};
							} else if (msg.type === 'result') {
								result = msg.result;
								$.each(result.set, function(key, value) {
									var bench = value[0];
									date = moment(result.commit.date).format('YYYY-MM-DD HH:mm:ss');

									item = {
										name: date,
										y: bench.NsPerOp,
									};

									var series = self.get(bench.Name);
									if (series) { // series already exists
										series.addPoint(item, true, false);
									} else { //  new series
										self.addSeries({
											data: [item],
											id: bench.Name,
											name: bench.Name,
										});
									}
								});

								// Now, iterate over known series, and insert nulls
								// if values are missing.
								$.each(self.series, function(index, serie) {
									found = false;
									$.each(serie.data, function(idx, item) {
										if (item.name == date) {
											found = true;
											return false;
										}
									});
									if (!found) {
										serie.addPoint({
											name: date,
											y: null,
										}, true, false)
									};
								});
							}
						}
					},
				},
			},
			title: { text: '{{ .PkgName }} benchmark' },
			subtitle: { text: 'created with gobenchui' },
			xAxis: {
				// we send commits from latest to first, so reverse
				reversed: true,
				categories: [],
			},
			yAxis: {
				title: { text: 'Time' },
				labels: {
					formatter: function () {
						return this.value + 'ns';
					}
				}
			},
			tooltip: {
				crosshairs: true,
				shared: true
			},
			{{ if .Series }} {{ .Series | json_stripped }} {{ end }}
		};

		window.onload = function() {
			var chart = $('#container').highcharts(options);
		};

	</script>
	<h1>Go Benchmark UI</h1>
	<div style="float: right">
		<h2>{{ len .Commits }} commits</h2>
		<h3>{{ with last .Commits}}{{ .Date.Format "2006-01-02" }}{{ end }} - {{ with index .Commits 1 }}{{ .Date.Format "2006-01-02" }}{{ end }}</h3>
	</div>
	<div style="float: left">
		<h2>{{ .PkgName }}</h2>
		<h3>Path: {{ .PkgPath }}</h3>
	</div>
	<div style="text-align: center">
		<h2>Status: <span id="status">{{ .Status }}</span></h2>
		{{ if .CurrentCommit }}
		<h5 id="commit_block">Current commit: <span id="commit">{{ .CurrentCommit.Date.Format "2006-01-02 15:04:05" }} ({{ .CurrentCommit.Subject }})<br />Hash: {{ .CurrentCommit.Hash }}</span></h5>
		{{ end }}
	</div>
	<div id="container"></div>
</body>
</html>
